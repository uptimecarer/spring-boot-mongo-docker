node{
    def mavenHome = tool name: "maven-3.9.6", type: "maven"
    stage('codeclone'){
        git credentialsId: 'Git_Cred', url: 'https://github.com/uptimecarer/spring-boot-mongo-docker.git'
    }
     stage('build artifact'){
      sh "${mavenHome}/bin/mvn clean package"
}
stage('createAnImage'){
    sh "docker build -t uptimecareeer/spring-boot-mongo:latest ."
}
stage('Docker Login and Push Image'){
      withCredentials([string(credentialsId: 'Docker_Hub_Pwd', variable: 'Docker_Hub_Pwd')]) {
      sh "docker login -u uptimecareeer -p ${Docker_Hub_Pwd}" 
    }
    sh "docker push uptimecareeer/spring-boot-mongo:latest"
}
 stage('Remove Local Image'){
      sh "docker rmi -f uptimecareeer/spring-boot-mongo:latest"
  } 
stage('DeployDockerSwarmCluster'){
    sshagent(['host_cred']) {
         sh 'scp -o StrictHostKeyChecking=no docker-composeswarm.yml ec2-user@13.233.132.18:'
      sh 'ssh -o StrictHostKeyChecking=no ec2-user@13.233.132.18 docker stack deploy --prune --compose-file docker-composeswarm.yml springboot'
    }
}
}
